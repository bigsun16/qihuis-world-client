
#user  nobody;
worker_processes  auto;

error_log  /nginx/logs/error.log warn;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
	use epoll;
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;
	
	log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
	access_log /nginx/logs/access.log main;
    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

	server {
		listen 80;
		server_name sunqihui.me www.sunqihui.me;  
	 
		# 将所有HTTP请求重定向到HTTPS
		return 301 https://$host$request_uri;
	}

	server {
		listen 443 ssl;
		http2 on;
		server_name sunqihui.me www.sunqihui.me;
		ssl_certificate /etc/nginx/ssl/live/sunqihui.me/fullchain.pem; # 证书文件路径
		ssl_certificate_key /etc/nginx/ssl/live/sunqihui.me/privkey.pem; # 私钥文件路径
 
		ssl_session_cache shared:SSL:1m;
		ssl_session_timeout 5m;
 
		ssl_ciphers HIGH:!aNULL:!MD5;
		ssl_protocols TLSv1.2 TLSv1.3; # 根据需要配置TLS协议版本
		ssl_prefer_server_ciphers on;

		root /usr/share/nginx/html;
		index index.html;
		location / {
		    try_files $uri $uri/ /index.html;		
		}

		location /qihuis-world {
			proxy_pass http://qihuis-world:8888;  # 后端API地址
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			client_body_buffer_size 1m;
			client_max_body_size 50m;
			proxy_read_timeout 60;
		}
		
		location /upload/opt/qihuis/wish_tree/upload/ {
			alias /opt/qihuis/wish_tree/upload/;
			autoindex off;  # 禁止列出目录内容
		}
	
    # 为静态图片提供服务
		location /images/ {
			alias /usr/share/nginx/images/;
			expires 30d;
			add_header Cache-Control "public, no-transform";
			types {
				image/jpeg jpeg;
				image/png png;
				image/gif gif;
			}
		}
	}
}
